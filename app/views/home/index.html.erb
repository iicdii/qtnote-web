<div class="main-header">
    <div class="motto">
        <h1 class="title-uppercase qt-eng">QT NOTE</h1>
        <h3><%=t "text.slogan" %></h3>
        <br>
        <button id="doIt" class="btn btn-danger"><%=t "text.start" %></a>
    </div>
</div>

<div class="main section">
    <div class="container">
        <div class="nav-tabs-navigation" style="border-bottom: 1px solid #D8C1AB;" role="tablist">
            <ul id="tabs" class="nav nav-tabs qt-nav-tabs" data-tabs="tabs">
                <li class="active" role="presentation"><a href="#word" aria-controls="word" data-toggle="tab" aria-expanded="true"><%=t "text.today_word" %></a></li>
                <li role="presentation"><a href="#shareQT" aria-controls="shareQT" data-toggle="tab" aria-expanded="false"><%=t "text.qt_share" %></a></li>
            </ul>
        </div>
        <div class="tab-content">
            <div role="tabpanel" class="tab-pane active" id="word">
                <h3><%=t "text.today_word" %>&nbsp;<i class="fa fa-check-square fa-2" aria-hidden="true" <% if @today_post %>style="color:#7ac29a;"<% end %>></i></h3>
                <div>
                    <div class="row" style="padding:5px 0 5px 0;">
                        <div class="col-md-12">
                            <span class="label label-danger">제목</span>
                            <span style="margin-left:5px;font-weight:600;"><%= @title %></span>
                        </div>
                    </div>
                    <div class="row" style="padding:5px 0 5px 0;">
                        <div class="col-md-12">
                            <span class="label label-danger">본문</span>
                            <span style="margin-left:5px;font-weight:600;"><%= @book_line %></span>
                        </div>
                    </div>
                </div>
                <table class="table" style="font-size:13px;">
                    <tbody>
                        <% @words.each do |t| %>
                            <tr>
                                <th><%= t.first %></th>
                                <td><%= t.second %></td>
                            </tr>
                        <% end %>
                    </tbody>
                </table>
                <%= form_tag({controller: "home", action: @today_post ? 'modify' : 'write'}, {id: "qt_form", method: "post"}) do |f| %>
                    <input type="hidden" name="id" value="<%= @today_post? @today_post.id : "" %>">
                    <div class="row">
                        <div class="col-md-4">
                            <h5><%=t "text.understanding" %>&nbsp;
                            <button class="btn btn-xs btn-success btn-fill" type="button" data-toggle="collapse" data-target="#collapse1" aria-expanded="false" aria-controls="collapse1">
                              <%=t "text.more" %>
                            </button>
                            </h5>
                            <div class="collapse" id="collapse1">
                                <div class="panel panel-success">
                                    <div class="panel-body">
                                    <% @info1.each do |t| %>
                                        <p class="qt-p"><%= t %></p>
                                    <% end %>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h5><%=t "text.whois" %>&nbsp;
                                <button class="btn btn-xs btn-success btn-fill" type="button" data-toggle="collapse" data-target="#collapse2" aria-expanded="false" aria-controls="collapse2">
                                  <%=t "text.more" %>
                                </button>
                            </h5>
                            <textarea id="whois" name="whois" class="form-control" rows="5" placeholder="<%=t 'text.at_least_character', count: 5 %>"><%= if @today_post then @today_post.whois elsif @temp_post then @temp_post[:whois] end %></textarea>
                            <div class="collapse" id="collapse2">
                                <div class="panel panel-success" style="margin-top:10px;">
                                    <div class="panel-body">
                                        <p class="qt-p"><%= @info2 %></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h5 <% if I18n.locale == :en then %>style="font-size:1.1em;margin-top:11px;margin-bottom:17px;"<% end %>><%=t "text.lesson" %>&nbsp;
                                <button class="btn btn-xs btn-success btn-fill" type="button" data-toggle="collapse" data-target="#collapse3" aria-expanded="false" aria-controls="collapse3">
                                  <%=t "text.more" %>
                                </button>
                            </h5>
                            <textarea id="lesson" name="lesson" class="form-control" rows="5" placeholder="<%=t 'text.at_least_character', count: 10 %>"><%= if @today_post then @today_post.lesson elsif @temp_post then @temp_post[:lesson] end %></textarea>
                            <div class="collapse" id="collapse3">
                                <div class="panel panel-success" style="margin-top:10px;">
                                    <div class="panel-body">
                                        <p class="qt-p"><%= @info3 %></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row" style="margin-top:10px;">
                        <div class="col-md-offset-4 col-md-4">
                            <h5><%=t "text.apply" %>&nbsp;
                                <button class="btn btn-xs btn-info btn-fill" style="padding:0;" type="button" data-toggle="popover" title="<%=t "text.apply" %>" data-content="오늘 말씀을 보고 내가 구체적으로 할 수 있는 일을 기록하세요.">
                                    <i class="fa fa-1 fa-question" style="margin:0 1.3px 0 0;" aria-hidden="true"></i>
                                </button>
                            </h5>
                            <textarea id="apply" name="apply" class="form-control" rows="5" placeholder="<%=t 'text.at_least_character', count: 5 %>"><%= if @today_post && @today_post.apply then @today_post.apply elsif @temp_post then @temp_post[:apply] end %></textarea>
                        </div>
                        <div class="col-md-4">
                            <h5><%=t "text.prayer" %></h5>
                            <textarea id="pray" name="pray" class="form-control" rows="5"><%= if @today_post && @today_post.pray then @today_post.pray elsif @temp_post then @temp_post[:pray] end %></textarea>
                        </div>
                    </div>
                    <div class="row" style="margin-top:20px;">
                        <div class="col-md-3 col-xs-3 text-left">
        
                        </div>
                        <div class="col-md-7 col-xs-7 col-xs-offset-2 col-md-offset-2 text-right">
                            <div style="display:inline-block; vertical-align:middle; padding-right: 25px;" <% if @today_post && @today_post.is_public then %>data-toggle="tooltip"<% end %> title="<%=t 'text.need_talent_to_update' %>" data-html="true">
                                <i id="lock" class="fa fa-lock fa-2x" style="margin-right: 10px;" aria-hidden="true"></i>
                                <input type="checkbox" name="is_public" id="is_public" <%= (@today_post && @today_post.is_public) || (@temp_post && @temp_post[:is_public]) ? "checked" : "" %> />
                                <i id="unlock" class="fa fa-unlock fa-2x" style="margin-left: 5px;" aria-hidden="true"></i>
                            </div>
                            <div style="display: inline-block;">
                            <% unless user_signed_in? %>
                                <button type="button" id="save_qt" class="btn btn-success" data-toggle="modal" data-target="#loginModal"><%=t 'text.save' %></button>
                            <% else %>
                                <% if @today_post %>
                                    <button type="submit" class="btn btn-info submit" data-loading-text="<i class='fa fa-circle-o-notch fa-spin'></i> <%=t 'text.sending' %>.."><%=t 'text.modify' %></button>
                                <% else %>
                                    <button type="submit" class="btn btn-success submit" data-loading-text="<i class='fa fa-circle-o-notch fa-spin'></i> <%=t 'text.sending' %>.."><%=t 'text.save' %></button>
                                <% end %>
                            <% end %>
                            </div>
                        </div>
                    </div>
                <% end %>
            </div>
            <div role="tabpanel" class="tab-pane" id="shareQT">
                <h3>오늘의 큐티나눔</h3>
                <% if @today_posts.exists? %>
                    <p style="font-size:14px;">총 <%= @today_posts.count %>개의 묵상을 나누고 있습니다.</p>
                    <div class="msgbox">
                    <% @today_posts.each do |p| %>
                        <% if user_signed_in? && p.user_id == current_user.id %>
                            <div class="row" style="padding-bottom:20px;">
                                <div class="col-md-12">
                                    <div class="row">
                                        <div class="col-md-11 col-sm-10 col-xs-9 text-right" style="padding-bottom: 10px;">
                                            <span class="qt-eng"><%= current_user.email.split("@").first %></span>
                                            <span class="qt-level-sm qt-num"><%= current_user.level %></span>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="row text-right">
                                                <div style="display:inline-block; float:none; margin-right:100px;">
                                                    <div class="col-table text-center" style="vertical-align:bottom; padding-left: 15px; padding-right: 10px;">
                                                        <span class="qt-talk-time"><%= time_ago_in_words(p.created_at) %></span>
                                                    </div>
                                                    <div class="talk me text-left">
                                                        <span><%=t 'text.whois' %></span>
                                                        <p><%= p.whois %></p>
                                                        <span><%=t 'text.lesson' %></span>
                                                        <p style="margin:0;"><%= p.lesson %></p>
                                                    </div>
                                                </div>
                                                <div style="position: absolute; right: 0; top: 0;">
                                                    <img src="http://image.flaticon.com/icons/svg/149/149071.svg" width="64" height="64">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% else %>
                            <div class="row" style="padding-bottom:20px;">
                                <div class="col-md-12">
                                    <div class="row">
                                        <div class="col-md-1 col-sm-2 col-xs-4"></div>
                                        <div class="col-md-11" style="padding-bottom: 10px; padding-left: 75px;">
                                            <span class="qt-eng"><%= User.find_by(id: p.user_id).email.split("@").first %></span>
                                            <span class="qt-level-sm qt-num"><%= User.find_by(id: p.user_id).level %></span>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="row" style="display:table;">
                                                <div class="col-md-1 col-table" style="padding-right: 25px;">
                                                    <img src="http://image.flaticon.com/icons/svg/149/149071.svg" width="64" height="64">
                                                </div>
                                                <div class="col-md-10 col-table" style="padding-right: 10px;">
                                                    <div class="talk other">
                                                        <span><%=t 'text.whois' %></span>
                                                        <p><%= p.whois %></p>
                                                        <span><%=t 'text.lesson' %></span>
                                                        <p style="margin:0;"><%= p.lesson %></p>
                                                    </div>
                                                    <div class="col-table" style="vertical-align:bottom; padding-left: 10px; padding-right: 10px;">
                                                        <span class="qt-talk-time"><%= time_ago_in_words(p.created_at) %></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% end %>
                    <% end %>
                    </div>
                <% else %>
                    <p>오늘 작성된 큐티나눔이 없습니다.</p>
                <% end %>
            </div>
        </div>
    </div>
</div>

<div class="section section-nude text-center">
    <div class="container">
        <h3 class="text-center"><%=t "text.share" %></h3>
        <p><%=t "text.share_sub" %></p>
        <div class="row" style="margin-top:20px;">
            <div class="col-md-3 col-xs-3">
                <a id="kakao-link-btn" href="javascript:;">
                    <img src="//dev.kakao.com/assets/img/about/logos/kakaolink/kakaolink_btn_medium.png" class="kakao-talk" />
                </a>
                <p class="qt-sns-title"><%=t "text.kakaotalk" %></p>
            </div>
            <div class="col-md-3 col-xs-3">
                <a id="kakaostory-share-button" href="javascript:shareKakaoStory('http://qtnote.co.kr', '<%=t 'text.slogan' %>');">
                    <img src="https://developers.kakao.com/assets/img/about/buttons/kakaostory/icon/flat/kakaostory_icon_flat_96x96.png" class="kakao-story" />
                </a>
                <p class="qt-sns-title"><%=t "text.kakaostory" %></p>
            </div>
            <div class="col-md-3 col-xs-3">
                <div class="social">
                    <a href="javascript:shareFacebook('http://qtnote.co.kr')">
                        <i class="fa fa-facebook" style="background-color:#3b5998;" aria-hidden="true"></i>
                    </a>
                </div>
                <p class="qt-sns-title"><%=t "text.facebook" %></p>
            </div>
            <div class="col-md-3 col-xs-3">
                <div class="social">
                    <a href="javascript:shareTwitter('http://qtnote.co.kr', '<%=t 'text.slogan' %>');">
                        <i class="fa fa-twitter" style="background-color:#00aced;" aria-hidden="true"></i>
                    </a>
                </div>
                <p class="qt-sns-title"><%=t "text.twitter" %></p>
            </div>
            
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // sudo service postgresql restart
        // 작성중이던 글이 있으면 페이지 로드 후 스크롤을 이동한다.
        <% if @temp_post %>
            <% if @temp_post[:whois].length > 3 || @temp_post[:lesson].length > 3 %>
        $('html, body').animate({
            scrollTop: $("#qt_form").offset().top
        }, 800);
            <% end %>
        <% end %>
        $("#doIt").click(function() {
            $('html, body').animate({
                scrollTop: $(".main").offset().top
            }, 800);
        });
        
        $('.submit').on('click', function() {
            var $this = $(this);
              $this.button('loading');
                setTimeout(function() {
                   $this.button('reset');
               }, 8000);
        });
        
        // 자동 저장
        // $("#qt_form").sisyphus({ timeout: 10, autoRelease: true });
        
        //<![CDATA[
        Kakao.init('c4d2ae3d66986351a92450b6b8bb7f8b');
        Kakao.Link.createTalkLinkButton({
          container: '#kakao-link-btn',
          label: '<%=t 'text.qtnote' %>',
          image: {
            src: 'https://i.imgur.com/RcmlX9F.png',
            width: '300',
            height: '160'
          },
          webButton: {
            text: '큐티노트 홈페이지로',
            url: 'http://qtnote.co.kr' // 앱 설정의 웹 플랫폼에 등록한 도메인의 URL이어야 합니다.
          }
        });
        //]]>
        
        if ($('#is_public').is(':checked')) {
            $('#unlock').css("color", "#7AC29A");
        } else {
            $('#lock').css("color", "#7AC29A");
        }
        
        $('#is_public').change(function(e) {
            if (e.target.checked){
                $('#lock').css("color", "#66615b");
                $('#unlock').css("color", "#7AC29A");
            } else {
                $('#lock').css("color", "#7AC29A");
                $('#unlock').css("color", "#66615b");
            }
        });
    });
    
    function shareFacebook(url){
    	window.open("http://www.facebook.com/sharer/sharer.php?u=" + url, "_blank", "width=600, height=400;");
    };
    
    function shareTwitter(url, text){
        window.open("https://twitter.com/intent/tweet?text=" + text + "&url=" + url, "_blank", "width=600, height=447;");
    };
    
    function shareKakaoStory(url, text){
        Kakao.Story.share({
            url: url,
            text: text
        });
        
    };
</script>